<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rider-Pi — Sterowanie ruchem (REST /api)</title>
  <style>
    /* DARK THEME — spójne z głównym dashboardem */
    :root { --pad: 16px; --gap: 12px; }
    body{
      font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0; padding:var(--pad);
      background:#0e1823; color:#e6eef7;
    }
    .wrap{max-width:1100px;margin:0 auto}
    h1{font-size:20px;margin:0 0 var(--pad)}
    .row{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center;margin:8px 0}
    .grid{display:grid;grid-template-columns:repeat(3,160px);gap:var(--gap);justify-content:center;margin:16px 0}

    .card{
      background:#0f2030;
      border:1px solid #1e3a56;
      border-radius:16px;
      box-shadow:0 1px 8px rgba(0,0,0,.25);
      padding:var(--pad); margin:0 0 var(--pad);
    }

    button{
      padding:12px 16px;
      border:1px solid #24425e;
      border-radius:12px;
      background:#122435; color:#e6eef7;
      font-size:16px; cursor:pointer;
      transition:transform .03s ease, background .12s ease, border-color .12s ease;
    }
    button:hover{ background:#16304a; border-color:#2b5577 }
    button:active{ transform:scale(0.98) }

    label{font-size:14px;color:#b7cee3;display:flex;align-items:center;gap:8px}
    input[type="range"]{width:160px; accent-color:#6de28a}
    input[type="number"]{
      width:100px;background:#0b1a27;color:#e6eef7;
      border:1px solid #24425e;border-radius:10px;padding:6px 8px
    }
    select{
      padding:8px 10px;border-radius:10px;
      border:1px solid #24425e;background:#0b1a27;color:#e6eef7
    }

    #log{
      height:220px; overflow:auto;
      background:#0b1a27; border:1px solid #1c3349;
      border-radius:10px; padding:8px;
      font-family:ui-monospace,Consolas,monospace; font-size:13px;
      white-space:pre-wrap;
    }

    .muted{opacity:.85}
    .ok{color:#6de28a}
    .warn{color:#f0c36d}
    .err{color:#ff8080}
    .kbd{
      font-family:ui-monospace,Consolas,monospace;
      background:#102233; border:1px solid #203a57;
      border-radius:6px; padding:2px 6px; margin:0 2px; color:#b7cee3
    }
    .spacer{flex:1}
    a{color:#98c7ff; text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Rider-Pi — Sterowanie ruchem
      <span id="apiStatus" class="muted" style="margin-left:8px">(checking…)</span>
    </h1>
    <div class="row">
      <label>Tryb lewo/prawo:
        <select id="lrMode">
          <option value="turn" selected>skręt (yaw)</option>
          <option value="strafe">straf (vy)</option>
        </select>
      </label>
      <label>Prędkość <span class="muted">(0..1)</span>:
        <input id="speed" type="range" min="0" max="1" step="0.05" value="0.6" />
        <span id="speedVal">0.60</span>
      </label>
      <label>Czas [s]:
        <input id="duration" type="number" min="0.1" step="0.1" value="0.6" />
      </label>
      <div class="spacer"></div>
      <button id="btnStop">■ STOP</button>
    </div>

    <div class="grid">
      <div></div>
      <button id="btnFwd">↑ Forward</button>
      <div></div>

      <button id="btnLeft">← Left</button>
      <button id="btnStop2">■ Stop</button>
      <button id="btnRight">Right →</button>

      <div></div>
      <button id="btnBack">↓ Backward</button>
      <div></div>
    </div>

    <div class="row">
      <span class="muted">Skróty: <span class="kbd">W</span>/<span class="kbd">S</span>/<span class="kbd">A</span>/<span class="kbd">D</span> lub strzałki; <span class="kbd">Spacja</span> = stop.</span>
      <div class="spacer"></div>
      <a href="/" class="muted">↩ dashboard</a>
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:16px;margin:0 0 8px">Zdarzenia (SSE /events)</h2>
    <div id="log"></div>
  </div>
</div>

<script>
  const qs = (s)=>document.querySelector(s);
  const speedEl = qs('#speed');
  const speedVal = qs('#speedVal');
  const durEl = qs('#duration');
  const lrModeEl = qs('#lrMode');
  const logEl = qs('#log');
  const apiStatus = qs('#apiStatus');

  function clamp(n, lo, hi){ n=Number(n)||0; return Math.max(lo, Math.min(hi, n)); }

  speedEl.addEventListener('input', ()=> speedVal.textContent = Number(speedEl.value).toFixed(2));

  async function pingHealth(){
    try{
      const r = await fetch('/healthz', {cache:'no-store'});
      if(!r.ok) throw new Error(r.status);
      const j = await r.json();
      const ok = (j.status === 'ok');
      apiStatus.textContent = ok ? 'ok' : 'degraded';
      apiStatus.className = ok ? 'ok' : 'warn';
    }catch(e){
      apiStatus.textContent = 'down';
      apiStatus.className = 'err';
    }
  }
  setInterval(pingHealth, 1000); pingHealth();

  function appendLog(msg, cls="") {
    const line = document.createElement('div');
    if (cls) line.className = cls;
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  async function sendMove(vx, vy, yaw, duration) {
    const body = { vx, vy, yaw, duration };
    try {
      const res = await fetch('/api/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      appendLog(`move → ${JSON.stringify(body)}`, 'ok');
    } catch (e) {
      appendLog(`ERROR move: ${e.message}`, 'err');
    }
  }

  async function sendStop() {
    try {
      const res = await fetch('/api/stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      appendLog('stop', 'warn');
    } catch (e) {
      appendLog(`ERROR stop: ${e.message}`, 'err');
    }
  }

  // Buttons
  qs('#btnFwd').addEventListener('click', ()=> {
    const s = clamp(speedEl.value, 0, 1), d = clamp(durEl.value, 0.1, 5);
    sendMove(+s, 0, 0, d);
  });
  qs('#btnBack').addEventListener('click', ()=> {
    const s = clamp(speedEl.value, 0, 1), d = clamp(durEl.value, 0.1, 5);
    sendMove(-s, 0, 0, d);
  });
  function leftRight(dir){ // dir: -1 for left, +1 for right
    const s = clamp(speedEl.value, 0, 1), d = clamp(durEl.value, 0.1, 5);
    if (lrModeEl.value === 'turn') {
      sendMove(0, 0, dir*s, d); // yaw
    } else {
      sendMove(0, dir*s, 0, d); // strafe vy
    }
  }
  qs('#btnLeft').addEventListener('click', ()=> leftRight(-1));
  qs('#btnRight').addEventListener('click', ()=> leftRight(+1));
  qs('#btnStop').addEventListener('click', sendStop);
  qs('#btnStop2').addEventListener('click', sendStop);

  // Keyboard: single-shot on keydown (ignore repeats). keyup triggers stop.
  const pressed = new Set();
  function isArrow(k){ return ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(k); }
  window.addEventListener('keydown', (ev)=>{
    if (ev.repeat) return;
    const k = ev.key;
    if (isArrow(k)) ev.preventDefault(); // anty-scroll
    pressed.add(k);
    if (k === ' '){ ev.preventDefault(); sendStop(); return; }
    const s = clamp(speedEl.value, 0, 1), d = clamp(durEl.value, 0.1, 5);
    if (k === 'w' || k === 'W' || k === 'ArrowUp')   sendMove(+s, 0, 0, d);
    if (k === 's' || k === 'S' || k === 'ArrowDown') sendMove(-s, 0, 0, d);
    if (k === 'a' || k === 'A' || k === 'ArrowLeft') leftRight(-1);
    if (k === 'd' || k === 'D' || k === 'ArrowRight')leftRight(+1);
  });
  window.addEventListener('keyup', (ev)=>{
    if (!pressed.has(ev.key)) return;
    pressed.delete(ev.key);
    if (['w','W','ArrowUp','s','S','ArrowDown','a','A','ArrowLeft','d','D','ArrowRight'].includes(ev.key)) {
      sendStop();
    }
  });

  // Awaryjny STOP przy ukryciu/wyjściu ze strony
  document.addEventListener('visibilitychange', ()=> {
    if (document.hidden) sendStop();
  });
  window.addEventListener('beforeunload', ()=> {
    try { navigator.sendBeacon('/api/stop', new Blob(['{}'], {type:'application/json'})); } catch(e){}
  });

  // SSE /events
  try{
    const es = new EventSource('/events');
    es.onmessage = (ev)=> {
      try{
        const obj = JSON.parse(ev.data);
        let line = obj.topic || 'event';
        if (typeof obj.data === 'string') {
          try {
            const d = JSON.parse(obj.data);
            if (d.event) line += ` :: ${d.event}`;
            else if (d.vx!==undefined || d.yaw!==undefined) line += ` :: ${JSON.stringify(d)}`;
          } catch(_){}
        }
        appendLog(line);
      }catch(e){
        appendLog(`event ${ev.data}`);
      }
    };
    es.onerror = ()=> appendLog('SSE disconnected', 'warn');
    appendLog('SSE connected');
  }catch(e){
    appendLog('SSE not supported', 'warn');
  }
</script>
</body>
</html>
