<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title data-i18n="dash.page_title">Rider-Pi — mini dashboard</title>
<style>
  body{margin:0;background:#0e1a24;color:#d7e2ee;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1180px;margin:28px auto;padding:0 18px}
  h1{font-size:28px;margin:0 0 8px}
  .hint{opacity:.6;font-size:12px;margin-bottom:18px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
  .card{background:#0f2233;border:1px solid #1d3548;border-radius:12px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .card h3{margin:0 0 10px;font-size:16px;color:#9cc8ff}
  .kv{display:grid;grid-template-columns:1fr auto;gap:6px 10px;font-size:13px}
  .kv div{opacity:.9}
  .ok{color:#5fe39a} .bad{color:#ff6b6b} .muted{opacity:.6}
  canvas{width:100%;height:140px;background:#0c1b28;border-radius:8px;border:1px solid #1d3548}
  a{color:#87b7ff}
  .legend{display:flex;gap:14px;margin-top:6px;font-size:12px;opacity:.8}
  .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle}
  .cpu{background:#6db3ff}.mem{background:#ffd36d}
  .thumb{background:#0c1b28;border:1px solid #1d3548;border-radius:10px;padding:8px}
  .thumb .cap{font-size:12px;opacity:.8;margin-bottom:6px}
  .thumb img{display:block;width:100%;height:auto;border-radius:6px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .cam-badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px;border:1px solid #2b5577;background:#11263a;color:#b7cee3}
  .cam-badge.on{border-color:#2d6a4f;color:#9be3b0;background:#103226}
  .cam-meta{font-size:12px;opacity:.8}
  .cam-img{width:100%;height:auto;border-radius:10px;border:1px solid #1d3548;background:#0c1b28}
  .statusbar{position:sticky;bottom:-1px;margin-top:18px;background:#0f2233;border:1px solid #1d3548;border-radius:10px;padding:10px 12px;display:flex;gap:14px;align-items:center;flex-wrap:wrap;font-size:13px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .pill{padding:2px 10px;border-radius:999px;border:1px solid #2b5577;background:#11263a;color:#b7cee3}
  .pill.ok{border-color:#2d6a4f;background:#103226;color:#9be3b0}
  .pill.bad{border-color:#7a2b2b;background:#2a1212;color:#ff9f9f}
  .sep{opacity:.4}
</style>
</head>
<body>
<div class="wrap">
  <h1 data-i18n="dash.page_title">Rider-Pi — mini dashboard</h1>
  <div class="hint">
    <span data-i18n="dash.hint_prefix">Auto-refresh co ≈ 2 s.</span>
    <span data-i18n="dash.hint_endpoints">Endpointy:</span>
    <a href="/healthz">/healthz</a>, <a href="/state">/state</a>, <a href="/sysinfo">/sysinfo</a>
    <span style="margin-left:8px">—</span>
    <a href="#" id="langPL">PL</a> | <a href="#" id="langEN">EN</a>
  </div>

  <div class="grid">
    <div class="card">
      <h3 data-i18n="dash.system.title">System</h3>
      <div class="kv">
        <div data-i18n="dash.system.cpu_est">cpu (szac.)</div><div id="ci_cpu" class="muted">—</div>
        <div data-i18n="dash.system.load">load (1/5/15)</div><div id="ci_load" class="muted">—</div>
        <div data-i18n="dash.system.mem">pamięć</div><div id="ci_mem" class="muted">—</div>
        <div data-i18n="dash.system.disk">dysk</div><div id="ci_disk" class="muted">—</div>
        <div data-i18n="dash.system.os">os</div><div id="ci_os" class="muted">—</div>
        <div data-i18n="dash.system.fw">fw</div><div id="ci_fw" class="muted">—</div>
      </div>
    </div>

    <div class="card">
      <h3 data-i18n="dash.devices.title">Urządzenia</h3>
      <div class="kv">
        <div data-i18n="dash.devices.camera">kamera</div><div id="d_cam" class="muted">—</div>
        <div data-i18n="dash.devices.lcd">lcd</div><div id="d_lcd" class="muted">—</div>
        <div data-i18n="dash.devices.xgo_imu">xgo.imu</div><div id="d_xgo_imu" class="muted">—</div>
        <div data-i18n="dash.devices.xgo_pose">xgo.pozycja</div><div id="d_xgo_pose" class="muted">—</div>
        <div data-i18n="dash.devices.xgo_battery">xgo.bateria</div><div id="d_xgo_batt" class="muted">—</div>
        <div data-i18n="dash.devices.temp">temp</div><div id="d_temp" class="muted">—</div>
      </div>
    </div>

    <div class="card">
      <h3 data-i18n="dash.history.title">Historia (60 s) — CPU / MEM</h3>
      <canvas id="chart" width="300" height="140"></canvas>
      <div class="legend">
        <span><i class="dot cpu"></i><span data-i18n="dash.history.cpu">cpu%</span></span>
        <span><i class="dot mem"></i><span data-i18n="dash.history.mem">mem%</span></span>
      </div>
    </div>

    <div class="card">
      <h3 style="display:flex;align-items:center;gap:8px" data-i18n="dash.camera.title">
        Kamera
        <span id="camBadge" class="cam-badge">…</span>
      </h3>
      <div class="cam-meta" id="camMeta" style="margin-bottom:6px">—</div>
      <div class="thumb">
        <div class="cap" data-i18n="dash.camera.caption">podgląd (ostatnia klatka lub komunikat)</div>
        <img id="img_cam" class="cam-img" src="/camera/placeholder" alt="kamera">
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:18px">
    <div class="card">
      <h3 data-i18n="dash.health.title">Health</h3>
      <div class="kv">
        <div data-i18n="dash.health.status">status</div><div id="h_status" class="ok">OK</div>
        <div data-i18n="dash.health.uptime">uptime</div><div id="h_uptime" class="muted">—</div>
        <div data-i18n="dash.health.bus_last_msg_age">bus.last_msg_age</div><div id="h_msg" class="muted">—</div>
        <div data-i18n="dash.health.bus_last_heartbeat_age">bus.last_heartbeat_age</div><div id="h_hb" class="muted">—</div>
      </div>
    </div>

    <div class="card">
      <h3 data-i18n="dash.presence.title">Obecność (vision.state)</h3>
      <div class="kv">
        <div data-i18n="dash.presence.present">obecny</div><div id="p_present" class="bad">false</div>
        <div data-i18n="dash.presence.confidence">pewność</div><div id="p_conf" class="muted">0.000</div>
        <div data-i18n="dash.presence.mode">tryb</div><div id="p_mode" class="muted">—</div>
        <div data-i18n="dash.presence.ts">ts</div><div id="p_ts" class="muted">—</div>
        <div data-i18n="dash.presence.age">wiek</div><div id="p_age" class="muted">—</div>
      </div>
    </div>

    <div class="card">
      <h3 data-i18n="dash.links.title">Linki</h3>
      <div class="kv">
        <div data-i18n="dash.links.events">zdarzenia (SSE)</div><div><a href="/events" target="_blank">/events</a></div>
        <div data-i18n="dash.links.metrics">metryki</div><div><a href="/metrics" target="_blank">/metrics</a></div>
        <div data-i18n="dash.links.repo">repozytorium</div><div><a href="https://github.com/mpieniak01/Rider-Pi" target="_blank">Rider-Pi</a></div>
        <div data-i18n="dash.links.control">sterowanie</div><div><a href="/control">/control</a></div>
      </div>
    </div>

    <div class="card">
      <h3 data-i18n="dash.camera_proc.title">Kamera — PROC</h3>
      <div class="thumb">
        <div class="cap" data-i18n="dash.camera_proc.caption">ramki / etykiety</div>
        <img id="img_proc" class="cam-img" src="/camera/placeholder" alt="processed camera">
      </div>
    </div>
  </div>

  <div class="statusbar" id="statusbar">
    <span class="pill" id="sb_presence"><span data-i18n="dash.status.vision_prefix">VISION:</span>&nbsp;<span id="sb_presence_state">—</span></span>
    <span class="sep">•</span>
    <span id="sb_mode" class="muted">mode: —</span>
    <span class="sep">•</span>
    <span id="sb_conf" class="muted">conf: —</span>
    <span class="sep">•</span>
    <span class="pill" id="sb_cam">CAM: —</span>
    <span id="sb_cam_meta" class="muted">fps: —</span>
  </div>
</div>

<script type="module">
import { initI18n, applyDom, t, setLang } from '/web/i18n.js?v=3';

const REFRESH_MS = 2000;
const CAM_REFRESH_MS = 5000;
const el = id=>document.getElementById(id);
const setTxt=(id,txt)=>{const e=el(id); if(e) e.textContent=txt}
const setCls=(id,cls)=>{const e=el(id); if(e) e.className=cls}
const fmt=(n,d=1)=> (n==null? '—' : (typeof n==='number'? Number(n).toFixed(d): n));

/* i18n wybór języka */
const urlLang = new URLSearchParams(location.search).get('lang');
const saved = localStorage.getItem('lang');
const browser = (navigator.language || '').slice(0,2).toLowerCase();
const pick = v => v && v.toLowerCase().startsWith('en') ? 'en' : (v && v.toLowerCase().startsWith('pl') ? 'pl' : null);
const lang = pick(urlLang) || pick(saved) || pick(browser) || 'pl';
if (urlLang) localStorage.setItem('lang', lang);
await initI18n(lang);
applyDom();
document.documentElement.setAttribute('lang', lang);
document.title = t('dash.page_title');
document.getElementById('langPL').addEventListener('click', e=>{e.preventDefault(); localStorage.setItem('lang','pl'); setLang('pl'); document.documentElement.setAttribute('lang','pl'); document.title=t('dash.page_title');});
document.getElementById('langEN').addEventListener('click', e=>{e.preventDefault(); localStorage.setItem('lang','en'); setLang('en'); document.documentElement.setAttribute('lang','en'); document.title=t('dash.page_title');});

/* wykres */
function drawChart(cpuArr=[], memArr=[]){
  const c = el('chart'); if(!c) return; const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const padL=30, padT=10, padR=10, padB=10; const W=c.width-padL-padR, H=c.height-padT-padB;
  ctx.strokeStyle='#1d3548'; ctx.strokeRect(padL,padT,W,H);
  ctx.fillStyle='#8aa'; ctx.font='10px sans-serif'; ctx.textAlign='right';
  [0,50,100].forEach(yv=>{ const y=padT+H-((yv/100)*H); ctx.beginPath(); ctx.moveTo(padL-4,y); ctx.lineTo(padL,y); ctx.strokeStyle='#1d3548'; ctx.stroke(); ctx.fillText(String(yv), padL-6, y+3); });
  function plot(arr,color){ if(!arr||arr.length<2) return; ctx.beginPath(); ctx.lineWidth=1.2; ctx.strokeStyle=color; const n=arr.length; for(let i=0;i<n;i++){ const x=padL+(i*(W/(n-1))); const v=Math.max(0,Math.min(100,Number(arr[i]||0))); const y=padT+H-((v/100)*H); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke(); }
  plot(cpuArr,'#6db3ff'); plot(memArr,'#ffd36d');
}

/* ===== KAMERA ===== */
async function refreshCamera(){
  const imgCam=el('img_cam'), imgProc=el('img_proc'), camBadge=el('camBadge'), camMeta=el('camMeta');
  const bust = Date.now();
  try{
    const st = await (await fetch('/state',{cache:'no-store'})).json();
    const cam = st.camera || {};
    if (camBadge){
      camBadge.textContent = cam.vision_enabled ? t('dash.camera.vision_on') : t('dash.camera.vision_off');
      camBadge.className   = 'cam-badge' + (cam.vision_enabled ? ' on' : '');
    }
    if (camMeta){
      camMeta.textContent = cam.last_frame_ts ? (t('dash.camera.last_frame_ts') + ' ' + new Date(cam.last_frame_ts*1000).toLocaleString())
                                              : t('dash.camera.no_last_frame');
    }
    const candidates = [`/api/last_frame?t=${bust}`, `/camera/last?t=${bust}`];
    let src = null;
    for(const u of candidates){
      try{ const r = await fetch(u, {method:'HEAD', cache:'no-store'}); if(r.ok){ src=u; break; } }catch{}
    }
    const ph = `/camera/placeholder?t=${bust}`;
    if (imgCam)  imgCam.src  = src || ph;
    if (imgProc) imgProc.src = src || ph;
  }catch{
    const ph = `/camera/placeholder?t=${Date.now()}`;
    if (imgCam)  imgCam.src  = ph;
    if (imgProc) imgProc.src = ph;
  }
}

/* ===== HEALTH (status/uptime + ages z wielu źródeł) ===== */
function updateHealth(h){
  const ok = !!(h && (h.ok===true || h.status==='ok' || h.state==='ok'));
  setTxt('h_status', ok? t('meta.ok'): 'degraded'); setCls('h_status', ok?'ok':'bad');

  if(h && h.uptime_s!=null){
    const s = Math.max(0, Math.floor(h.uptime_s));
    const HH = Math.floor(s/3600), MM = String(Math.floor((s%3600)/60)).padStart(2,'0'), SS = String(s%60).padStart(2,'0');
    setTxt('h_uptime', `${HH}:${MM}:${SS}`);
  } else setTxt('h_uptime','—');

  const msg = h?.bus?.last_msg_age_s ?? h?.bus?.last_msg_age;
  if (msg!=null) setTxt('h_msg', `${Number(msg).toFixed(1)} s`);

  let hb = h?.bus?.last_heartbeat_age_s ?? h?.bus?.last_hb_age_s ?? h?.bus?.heartbeat_age_s ?? null;
  if (hb==null){
    const ts = h?.bus?.last_heartbeat_ts ?? h?.bus?.heartbeat_ts ?? null;
    if (ts!=null) hb = Math.max(0, (Date.now()/1000) - Number(ts));
  }
  if (hb!=null) setTxt('h_hb', `${Number(hb).toFixed(1)} s`);
}

/* jeśli jeszcze brak, spróbuj z /api/bus/health */
async function busHeartbeatFallback(){
  try{
    const r = await fetch('/api/bus/health', {cache:'no-store'});
    if(!r.ok) return;
    const j = await r.json().catch(()=>null); if(!j) return;
    const lag = j?.bus?.last_msg_age_s ?? j?.bus?.last_msg_age;
    if (lag!=null) setTxt('h_msg', `${Number(lag).toFixed(1)} s`);
    let hb = j?.bus?.last_heartbeat_age_s ?? j?.bus?.last_hb_age_s ?? j?.bus?.heartbeat_age_s;
    if (hb==null){
      const ts = j?.bus?.last_heartbeat_ts ?? j?.bus?.heartbeat_ts;
      if (ts!=null) hb = Math.max(0, (Date.now()/1000) - Number(ts));
    }
    if (hb!=null) setTxt('h_hb', `${Number(hb).toFixed(1)} s`);
  }catch{}
}

/* ===== PRESENCE ===== */
function updateStateUI(s){
  setTxt('p_present', String(!!s.present)); setCls('p_present', s.present? 'ok':'bad');
  setTxt('p_conf', fmt(s.confidence,3)); setTxt('p_mode', s.mode || '—');
  setTxt('p_ts', s.ts? new Date(s.ts*1000).toLocaleTimeString(): '—');
  setTxt('p_age', (s.age_s!=null? fmt(s.age_s,1)+' s':'—'));
  setTxt('sb_presence_state', s.present? t('dash.status.present'): t('dash.status.idle'));
  setCls('sb_presence', 'pill '+(s.present?'ok':'bad'));
  setTxt('sb_mode', `${t('dash.status.mode')}: ${s.mode || '—'}`);
  setTxt('sb_conf', `${t('dash.status.conf')}: ${fmt(s.confidence,3)}`);
}

/* ===== DEVICES: /state + fallback /healthz.devices ===== */
function textFromLCD(lcd){
  if(!lcd) return '—';
  const parts = [];
  parts.push(lcd.on ? 'ON' : 'OFF');
  if (lcd.rot!=null) parts.push('rot '+lcd.rot);
  if (lcd.presenting) parts.push('presenting');
  if (lcd.no_draw) parts.push('no_draw');
  return parts.join(' · ');
}
function applyDevices({state, health}){
  // CAMERA
  const cam = state?.camera ?? health?.devices?.camera ?? {};
  const resTxt = (cam.res && cam.res.length===2)? ` ${cam.res[0]}×${cam.res[1]}` : '';
  const camTxt = (cam.on? 'ON':'OFF') + (cam.mode?(' · '+cam.mode):'') + resTxt + (cam.fps!=null? (' · '+fmt(cam.fps,1)+' fps'):'');
  setTxt('d_cam', camTxt); setCls('d_cam', cam.on? 'ok':'muted');

  // LCD
  const lcd = state?.lcd ?? health?.devices?.lcd ?? null;
  const lcdTxt = textFromLCD(lcd);
  setTxt('d_lcd', lcdTxt); setCls('d_lcd', (lcd && lcd.on)? 'ok':'muted');

  // XGO
  const xgo = state?.xgo ?? health?.devices?.xgo ?? {};
  const imuTxt = (xgo.on? 'ON':'OFF') + (xgo.imu_ok===true? ' · OK': (xgo.on? ' · ?':''));
  setTxt('d_xgo_imu', imuTxt); setCls('d_xgo_imu', (xgo.on && xgo.imu_ok)? 'ok':'muted');

  // POSE
  const parts = [];
  if (Array.isArray(xgo.pose) && xgo.pose.some(v=>v!=null)) {
    parts.push(xgo.pose.filter(v=>v!=null).map(v=>Number(v).toFixed(1)).join('°, ')+'°');
  }
  if (typeof xgo.pose==='string' && xgo.pose.trim()) parts.push(xgo.pose.trim());
  if (xgo.roll!=null)  parts.push(`r ${fmt(xgo.roll,1)}°`);
  if (xgo.pitch!=null) parts.push(`p ${fmt(xgo.pitch,1)}°`);
  if (xgo.yaw!=null)   parts.push(`y ${fmt(xgo.yaw,1)}°`);
  setTxt('d_xgo_pose', parts.length? parts.join(' · ') : '—');

  // BATTERY
  const battPct = (xgo.battery_pct ?? xgo.batt_pct ?? xgo.battery?.pct ?? xgo.battery);
  setTxt('d_xgo_batt', (battPct!=null? `${Number(battPct).toFixed(0)}%` : '—'));
  setCls('d_xgo_batt', (battPct!=null? 'ok':'muted'));

  // FW (na kartę System)
  const fw = xgo.fw ?? state?.fw ?? health?.devices?.xgo?.fw;
  if (fw) setTxt('ci_fw', fw);
}

/* ===== SYSINFO ===== */
function applySysinfo(si){
  if(!si) return;
  setTxt('ci_cpu', si.cpu_pct!=null? fmt(si.cpu_pct,1)+'%':'—');
  setTxt('ci_load', `${fmt(si.load1,2)}/${fmt(si.load5,2)}/${fmt(si.load15,2)}`);

  const mb = v => (v==null ? '—' : Number(v).toFixed(1)+' MB');
  if (si.mem_total_mb!=null && si.mem_used_mb!=null){
    const pct = si.mem_pct!=null ? ` (${fmt(si.mem_pct,1)}%)` : '';
    setTxt('ci_mem', `${mb(si.mem_used_mb)} / ${mb(si.mem_total_mb)}${pct}`);
  } else setTxt('ci_mem','—');

  const gb = v => (v==null ? '—' : Number(v).toFixed(1)+' GB');
  if (si.disk_total_gb!=null && si.disk_used_gb!=null){
    const pct = si.disk_pct!=null ? ` (${fmt(si.disk_pct,1)}%)` : '';
    setTxt('ci_disk', `${gb(si.disk_used_gb)} / ${gb(si.disk_total_gb)}${pct}`);
  } else setTxt('ci_disk','—');

  setTxt('ci_os', si.os_release || si.platform || '—');
  setTxt('d_temp', (si.temp_c!=null ? fmt(si.temp_c,1)+' °C' : '—'));

  // FW z sysinfo (fallback)
  const fw = si.fw || si.fw_version || si.firmware || si.version;
  if (fw) setTxt('ci_fw', fw);

  drawChart(si.hist_cpu || [], si.hist_mem || []);
}

/* ===== Poll ===== */
let lastHealth = null, lastState = null;
async function tick(){
  try{ lastHealth = await (await fetch('/healthz',{cache:'no-store'})).json(); updateHealth(lastHealth);}catch{}
  try{ await busHeartbeatFallback(); }catch{}
  try{ lastState  = await (await fetch('/state',{cache:'no-store'})).json(); updateStateUI(lastState);}catch{}
  try{ applyDevices({state:lastState, health:lastHealth}); }catch{}
  try{ const si = await (await fetch('/sysinfo',{cache:'no-store'})).json(); applySysinfo(si);}catch{}
}

/* lekkie SSE */
function startSSE(){ try{ const es=new EventSource('/events'); es.onmessage=()=>{}; es.onerror=()=>{}; }catch{} }

setInterval(tick, REFRESH_MS); tick();
setInterval(refreshCamera, CAM_REFRESH_MS); refreshCamera();
startSSE();
</script>
</body>
</html>
